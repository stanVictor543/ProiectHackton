<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clasificator Imagini</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        /* Stiluri CSS pentru modulul camerei */
        .camera-container {
            border: 2px dashed var(--bs-secondary);
            border-radius: 0.5rem;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            text-align: center;
            background-color: rgba(0, 0, 0, 0.1);
            position: relative;
        }

        #videoPreview {
            width: 100%;
            height: auto;
            border-radius: 0.25rem;
            object-fit: cover;
            max-height: 350px; /* LimitƒÉ √ÆnƒÉl»õimea pentru a se potrivi cu previzualizarea */
            display: none; /* Ascuns ini»õial */
        }
        
        #cameraPlaceholder {
            color: #6c757d;
            font-size: 1.2rem;
        }

        /* Ascundem canvas-ul, √Æl folosim doar pentru capturƒÉ */
        #cameraCanvas {
            display: none;
        }

        /* Stil pentru a alinia butoanele de upload »ôi camerƒÉ */
        .step-one-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        /* Ajustare stil pentru a se potrivi cu celelalte elemente */
        .bg-card-dark {
            /* Presupun√¢nd cƒÉ aceastƒÉ clasƒÉ seteazƒÉ culorile de fundal */
            background-color: #343a40; /* √énlocuie»ôte cu culoarea ta realƒÉ de fundal */
            color: #f8f9fa; /* Text deschis */
        }
        .bg-dark-theme {
             /* Presupun√¢nd cƒÉ aceastƒÉ clasƒÉ seteazƒÉ culorile de fundal */
            background-color: #212529;
        }
    </style>
</head>
<body class="bg-dark-theme"> 
    <div class="container mt-5 mb-5">
        <div class="row justify-content-center">
            <div class="col-lg-10 col-md-12">

                <div class="card shadow-lg border-0 bg-card-dark">
                    
                    <div class="card-header bg-primary-theme text-center p-4">
                        <h1 class="h3 mb-0">ü§ñ Clasificator: Robo»õi vs. Oameni üë©‚ÄçüöÄ</h1>
                    </div>
                    
                    <div class="card-body p-4 p-md-5">

                        <div class="row g-5 align-items-start">
                            
                            <div class="col-md-6">
                                <h3 class="h4 mb-3">Pasul 1: SelecteazƒÉ o Imagine</h3>
                                
                                <div class="step-one-options">
                                    
                                    <div>
                                        <h4 class="h5 mb-3 text-center">1.A: √éncarcƒÉ Fi»ôier</h4>
                                        <div id="dropZone" class="drop-zone-container">
                                            <input class="form-control" type="file" id="imageUpload" accept="image/jpeg, image/png" hidden>
                                            <label for="imageUpload" class="drop-zone-label">
                                                <i class="bi bi-cloud-arrow-up-fill"></i>
                                                <span class="mt-3 fs-5 fw-bold">Trage»õi imaginea aici</span>
                                                <span class="fs-6 text-muted">sau face»õi clic pentru a selecta</span>
                                            </label>
                                        </div>
                                    </div>

                                    <div>
                                        <h4 class="h5 mb-3 text-center">1.B: FƒÉ o PozƒÉ</h4>
                                        <div class="camera-container">
                                            <div id="cameraPlaceholder">
                                                <i class="bi bi-camera-video-fill display-5"></i>
                                                <p class="mt-2 mb-0">ApƒÉsa»õi "ActiveazƒÉ Camera"</p>
                                            </div>
                                            <video id="videoPreview" autoplay></video>
                                            <canvas id="cameraCanvas"></canvas>
                                        </div>
                                        <div class="d-grid mt-3">
                                            <button id="cameraToggleBtn" class="btn btn-outline-primary">
                                                <i class="bi bi-camera-video"></i> ActiveazƒÉ Camera
                                            </button>
                                            <button id="captureBtn" class="btn btn-primary mt-2" disabled>
                                                <i class="bi bi-camera"></i> FƒÉ PozƒÉ
                                            </button>
                                        </div>
                                    </div>
                                    
                                </div>
                                <div class="d-grid mt-4">
                                    <button id="classifyBtn" class="btn btn-secondary-theme btn-lg">
                                        Pasul 2: ClasificƒÉ Imaginea
                                        <i class="bi bi-arrow-right-short ms-1"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h3 class="h4 mb-3">Pasul 3: Vezi Rezultatul</h3>

                                <div id="noPreview" class="no-preview-box">
                                    <span>A»ôtept imagine...</span>
                                </div>

                                <div id="imagePreviewContainer" class="image-preview-container mb-0 text-center" style="display: none;">
                                    <div class="scan-line"></div>
                                    <img id="imagePreview" src="#" alt="Previzualizare" class="img-fluid" />
                                </div>
                                
                                <div id="progressContainer" class="progress-container" style="display: none;">
                                    <div id="progressBar" class="progress-bar-custom"></div>
                                </div>


                                <div id="resultsArea" class="mt-4" style="display: none;">
                                    <div id="resultBox" class="result-box-custom">
                                        
                                        <div id="primaryResult" class="result-partition primary">
                                            <span class="result-percentage" id="primaryPercentage">...</span>
                                            <span class="result-label" id="primaryLabel">...</span>
                                        </div>
                                        
                                        <div id="secondaryResult" class="result-partition secondary">
                                            <span class="result-percentage" id="secondaryPercentage">...</span>
                                            <span class="result-label" id="secondaryLabel">...</span>
                                        </div>
                                        
                                    </div>
                                </div>
                                
                            </div>
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- SelectƒÉm elementele DOM ---
        const imageUpload = document.getElementById('imageUpload');
        const previewContainer = document.getElementById('imagePreviewContainer');
        const preview = document.getElementById('imagePreview');
        const classifyBtn = document.getElementById('classifyBtn');
        const dropZone = document.getElementById('dropZone');
        const noPreview = document.getElementById('noPreview');
        
        // Elementele camerei noi
        const cameraToggleBtn = document.getElementById('cameraToggleBtn');
        const captureBtn = document.getElementById('captureBtn');
        const videoPreview = document.getElementById('videoPreview');
        const cameraCanvas = document.getElementById('cameraCanvas');
        const cameraPlaceholder = document.getElementById('cameraPlaceholder');
        let cameraStream = null; // VariabilƒÉ pentru a stoca fluxul camerei

        // Elemente pentru progres »ôi rezultate (restul codului existent)
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const resultsArea = document.getElementById('resultsArea');
        const resultBox = document.getElementById('resultBox');
        const primaryPercentageEl = document.getElementById('primaryPercentage');
        const primaryLabelEl = document.getElementById('primaryLabel');
        const secondaryPercentageEl = document.getElementById('secondaryPercentage');
        const secondaryLabelEl = document.getElementById('secondaryLabel');
        const primaryResultDiv = document.getElementById('primaryResult');
        const secondaryResultDiv = document.getElementById('secondaryResult');

        const classifyBtnText = 'Pasul 2: ClasificƒÉ Imaginea <i class="bi bi-arrow-right-short ms-1"></i>';

        // --- Func»õie centralizatƒÉ pentru gestionarea fi»ôierului ---
        function handleFile(file) {
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    previewContainer.style.display = 'block'; 
                    noPreview.style.display = 'none'; 
                    
                    // ReseteazƒÉ rezultatele »ôi progresul
                    resultsArea.style.display = 'none'; 
                    progressContainer.style.display = 'none';
                    progressBar.style.animation = 'none';
                    resultBox.classList.remove('result-robot', 'result-om', 'result-eroare');
                }
                
                reader.readAsDataURL(file);

                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                imageUpload.files = dataTransfer.files; // SeteazƒÉ fi»ôierul pe input
            } else {
                alert('VƒÉ rugƒÉm sƒÉ alege»õi un fi»ôier de tip imagine (jpeg, png).');
            }
        }

        // --- 1. Logica pentru Drag & Drop ---
        dropZone.addEventListener('dragover', (event) => {
            event.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (event) => {
            event.preventDefault();
            dropZone.classList.remove('drag-over');
            const file = event.dataTransfer.files[0];
            handleFile(file);
        });

        // --- 2. Logica pentru input-ul de fi»ôier (la clic) ---
        imageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            handleFile(file);
        });

        // --- 3. Logica Camerei Web ---

        // Oprirea fluxului camerei
        function stopCameraStream() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            videoPreview.style.display = 'none';
            cameraPlaceholder.style.display = 'block';
            captureBtn.disabled = true;
            cameraToggleBtn.innerHTML = '<i class="bi bi-camera-video"></i> ActiveazƒÉ Camera';
            cameraToggleBtn.classList.remove('btn-danger');
            cameraToggleBtn.classList.add('btn-outline-primary');
        }

        // Pornirea fluxului camerei
        async function startCameraStream() {
            try {
                // Cerem permisiunea de a accesa camera, prefer√¢nd camera din spate (dacƒÉ e disponibilƒÉ pe mobil)
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } // 'environment' pentru camera din spate
                });

                // DacƒÉ 'environment' nu merge, √ÆncearcƒÉ camera implicitƒÉ
                if (!cameraStream) {
                    cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
                }

                videoPreview.srcObject = cameraStream;
                videoPreview.style.display = 'block';
                cameraPlaceholder.style.display = 'none';
                captureBtn.disabled = false;
                cameraToggleBtn.innerHTML = '<i class="bi bi-stop-circle"></i> Opre»ôte Camera';
                cameraToggleBtn.classList.remove('btn-outline-primary');
                cameraToggleBtn.classList.add('btn-danger');

                // Oprim camera dacƒÉ se selecteazƒÉ un fi»ôier din input
                imageUpload.addEventListener('change', stopCameraStream, { once: true });
                
            } catch (err) {
                console.error("Eroare la accesarea camerei: ", err);
                alert("Nu s-a putut accesa camera. Asigura»õi-vƒÉ cƒÉ ave»õi o camerƒÉ conectatƒÉ »ôi cƒÉ a»õi acordat permisiunea.");
                stopCameraStream(); // AsigurƒÉm resetarea butonului
            }
        }

        // Toggle pentru activare/dezactivare camerƒÉ
        cameraToggleBtn.addEventListener('click', () => {
            if (cameraStream) {
                stopCameraStream();
            } else {
                startCameraStream();
            }
        });

        // Captura imaginii
        captureBtn.addEventListener('click', () => {
            if (!cameraStream) return;

            // SeteazƒÉ dimensiunea canvas-ului la dimensiunea video-ului (pentru a men»õine aspect ratio)
            cameraCanvas.width = videoPreview.videoWidth;
            cameraCanvas.height = videoPreview.videoHeight;

            // DeseneazƒÉ frame-ul curent al video-ului pe canvas
            const context = cameraCanvas.getContext('2d');
            context.drawImage(videoPreview, 0, 0, cameraCanvas.width, cameraCanvas.height);

            // ExportƒÉ imaginea din canvas ca Blob (fi»ôier)
            cameraCanvas.toBlob((blob) => {
                const capturedFile = new File([blob], "camera_capture.png", { 
                    type: "image/png", 
                    lastModified: Date.now() 
                });
                
                // TrateazƒÉ poza ca pe orice alt fi»ôier √ÆncƒÉrcat
                handleFile(capturedFile);
                
                // Oprim camera dupƒÉ ce am fƒÉcut poza
                stopCameraStream();
            }, 'image/png');
        });

        // --- 4. Logica pentru trimiterea imaginii la backend (API Fetch) - RESTUL CODULUI RƒÇM√ÇNE IDENTIC CU CEL DAT DE TINE ---
        classifyBtn.addEventListener('click', async function() {
            
            const file = imageUpload.files[0];

            if (!file) {
                alert('VƒÉ rugƒÉm sƒÉ alege»õi o imagine mai √Ænt√¢i.');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            // Afi»ôƒÉm un status de "loading"
            classifyBtn.disabled = true;
            classifyBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Se clasificƒÉ...';
            
            resultsArea.style.display = 'none';
            resultBox.classList.remove('result-robot', 'result-om', 'result-eroare');

            // --- START ANIMA»öII (Scanare + BarƒÉ progres) ---
            previewContainer.classList.add('is-scanning');
            progressContainer.style.display = 'block';
            
            progressBar.style.animation = 'none'; 
            progressBar.offsetHeight; // Truc pentru a for»õa reflow
            progressBar.style.animation = 'fillBar 2.5s ease-out forwards';


            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // --- POPULƒÇM NOUL FORMAT DE REZULTAT ---
                const confidencePercent = data.confidence * 100;
                const otherPercent = 100 - confidencePercent;
                const predictedClass = data.predicted_class.toLowerCase();

                // AsigurƒÉm vizibilitatea ambelor pƒÉr»õi
                primaryResultDiv.style.display = 'block';
                secondaryResultDiv.style.display = 'flex'; // 'flex' e stilul implicit

                if (predictedClass === 'robot') {
                    primaryPercentageEl.textContent = `${confidencePercent.toFixed(1)}%`;
                    primaryLabelEl.textContent = 'Robot';
                    secondaryPercentageEl.textContent = `${otherPercent.toFixed(1)}%`;
                    secondaryLabelEl.textContent = 'Om';
                    resultBox.classList.add('result-robot');
                } else {
                    primaryPercentageEl.textContent = `${confidencePercent.toFixed(1)}%`;
                    primaryLabelEl.textContent = 'Om';
                    secondaryPercentageEl.textContent = `${otherPercent.toFixed(1)}%`;
                    secondaryLabelEl.textContent = 'Robot';
                    resultBox.classList.add('result-om');
                }
                
                resultsArea.style.display = 'block';

            } catch (error) {
                console.error('Eroare la clasificare:', error);
                
                // --- AFI»òARE EROARE √éN NOUL FORMAT ---
                primaryPercentageEl.textContent = 'Eroare';
                primaryLabelEl.textContent = error.message || 'Eroare necunoscutƒÉ';
                
                // Ascundem partea secundarƒÉ la eroare
                primaryResultDiv.style.display = 'block';
                secondaryResultDiv.style.display = 'none';

                resultBox.classList.add('result-eroare');
                resultsArea.style.display = 'block';
            
            } finally {
                // ReactivƒÉm butonul
                classifyBtn.disabled = false;
                classifyBtn.innerHTML = classifyBtnText;

                // --- STOP ANIMA»öIE SCANARE ---
                previewContainer.classList.remove('is-scanning');
                
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    progressBar.style.animation = 'none'; // Reset
                }, 500); 
            }
        });
    </script>
</body>
</html>