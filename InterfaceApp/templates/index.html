<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clasificator Imagini</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-dark-theme"> <div class="container mt-5 mb-5">
        <div class="row justify-content-center">
            <div class="col-lg-10 col-md-12">

                <div class="card shadow-lg border-0 bg-card-dark">
                    
                    <div class="card-header bg-primary-theme text-center p-4">
                        <h1 class="h3 mb-0">ü§ñ Clasificator: Robo»õi vs. Oameni üë©‚ÄçüöÄ</h1>
                    </div>
                    
                    <div class="card-body p-4 p-md-5">

                        <div class="row g-5 align-items-start">
                            
                            <div class="col-md-6">
                                <h3 class="h4 mb-3">Pasul 1: √éncarcƒÉ o Imagine</h3>

                                <div id="dropZone" class="drop-zone-container">
                                    <input class="form-control" type="file" id="imageUpload" accept="image/jpeg, image/png" hidden>
                                    <label for="imageUpload" class="drop-zone-label">
                                        <i class="bi bi-cloud-arrow-up-fill"></i>
                                        <span class="mt-3 fs-5 fw-bold">Trage»õi imaginea aici</span>
                                        <span class="fs-6 text-muted">sau face»õi clic pentru a selecta</span>
                                    </label>
                                </div>

                                <div class="d-grid mt-4">
                                    <button id="classifyBtn" class="btn btn-secondary-theme btn-lg">
                                        Pasul 2: ClasificƒÉ Imaginea
                                        <i class="bi bi-arrow-right-short ms-1"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <h3 class="h4 mb-3">Pasul 3: Vezi Rezultatul</h3>

                                <div id="noPreview" class="no-preview-box">
                                    <span>A»ôtept imagine...</span>
                                </div>

                                <div id="imagePreviewContainer" class="image-preview-container mb-0 text-center" style="display: none;">
                                    <div class="scan-line"></div>
                                    <img id="imagePreview" src="#" alt="Previzualizare" class="img-fluid" />
                                </div>
                                
                                <div id="progressContainer" class="progress-container" style="display: none;">
                                    <div id="progressBar" class="progress-bar-custom"></div>
                                </div>


                                <div id="resultsArea" class="mt-4" style="display: none;">
                                    <div id="resultBox" class="result-box-custom">
                                        
                                        <div id="primaryResult" class="result-partition primary">
                                            <span class="result-percentage" id="primaryPercentage">...</span>
                                            <span class="result-label" id="primaryLabel">...</span>
                                        </div>
                                        
                                        <div id="secondaryResult" class="result-partition secondary">
                                            <span class="result-percentage" id="secondaryPercentage">...</span>
                                            <span class="result-label" id="secondaryLabel">...</span>
                                        </div>
                                        
                                    </div>
                                </div>
                                
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- SelectƒÉm elementele DOM ---
        const imageUpload = document.getElementById('imageUpload');
        const previewContainer = document.getElementById('imagePreviewContainer');
        const preview = document.getElementById('imagePreview');
        const classifyBtn = document.getElementById('classifyBtn');
        const dropZone = document.getElementById('dropZone');
        const noPreview = document.getElementById('noPreview');
        
        // Elemente noi pentru progres »ôi rezultate
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const resultsArea = document.getElementById('resultsArea');
        const resultBox = document.getElementById('resultBox');
        const primaryPercentageEl = document.getElementById('primaryPercentage');
        const primaryLabelEl = document.getElementById('primaryLabel');
        const secondaryPercentageEl = document.getElementById('secondaryPercentage');
        const secondaryLabelEl = document.getElementById('secondaryLabel');
        
        // PƒÉr»õile din resultBox (pentru a le arƒÉta/ascunde la eroare)
        const primaryResultDiv = document.getElementById('primaryResult');
        const secondaryResultDiv = document.getElementById('secondaryResult');

        const classifyBtnText = 'Pasul 2: ClasificƒÉ Imaginea <i class="bi bi-arrow-right-short ms-1"></i>';

        // --- Func»õie centralizatƒÉ pentru gestionarea fi»ôierului ---
        function handleFile(file) {
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    previewContainer.style.display = 'block'; 
                    noPreview.style.display = 'none'; 
                    
                    // ReseteazƒÉ rezultatele »ôi progresul
                    resultsArea.style.display = 'none'; 
                    progressContainer.style.display = 'none';
                    progressBar.style.animation = 'none';
                    resultBox.classList.remove('result-robot', 'result-om', 'result-eroare');
                }
                
                reader.readAsDataURL(file);

                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                imageUpload.files = dataTransfer.files;

            } else {
                alert('VƒÉ rugƒÉm sƒÉ alege»õi un fi»ôier de tip imagine (jpeg, png).');
            }
        }

        // --- 1. Logica pentru Drag & Drop ---
        dropZone.addEventListener('dragover', (event) => {
            event.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (event) => {
            event.preventDefault();
            dropZone.classList.remove('drag-over');
            const file = event.dataTransfer.files[0];
            handleFile(file);
        });

        // --- 2. Logica pentru input-ul de fi»ôier (la clic) ---
        imageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            handleFile(file);
        });

        // --- 3. Logica pentru trimiterea imaginii la backend (API Fetch) ---
        classifyBtn.addEventListener('click', async function() {
            
            const file = imageUpload.files[0];

            if (!file) {
                alert('VƒÉ rugƒÉm sƒÉ alege»õi o imagine mai √Ænt√¢i.');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            // Afi»ôƒÉm un status de "loading"
            classifyBtn.disabled = true;
            classifyBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Se clasificƒÉ...';
            
            resultsArea.style.display = 'none';
            resultBox.classList.remove('result-robot', 'result-om', 'result-eroare');

            // --- START ANIMA»öII (Scanare + BarƒÉ progres) ---
            previewContainer.classList.add('is-scanning');
            progressContainer.style.display = 'block';
            
            // ResetƒÉm »ôi pornim anima»õia barei de progres
            // Durata (2.5s) este aceea»ôi cu cea a liniei de scanare
            progressBar.style.animation = 'none'; 
            progressBar.offsetHeight; // Truc pentru a for»õa reflow
            progressBar.style.animation = 'fillBar 2.5s ease-out forwards';


            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // --- POPULƒÇM NOUL FORMAT DE REZULTAT ---
                const confidencePercent = data.confidence * 100;
                const otherPercent = 100 - confidencePercent;
                const predictedClass = data.predicted_class.toLowerCase();

                // AsigurƒÉm vizibilitatea ambelor pƒÉr»õi
                primaryResultDiv.style.display = 'block';
                secondaryResultDiv.style.display = 'flex'; // 'flex' e stilul implicit

                if (predictedClass === 'robot') {
                    primaryPercentageEl.textContent = `${confidencePercent.toFixed(1)}%`;
                    primaryLabelEl.textContent = 'Robot';
                    secondaryPercentageEl.textContent = `${otherPercent.toFixed(1)}%`;
                    secondaryLabelEl.textContent = 'Om';
                    resultBox.classList.add('result-robot');
                } else {
                    primaryPercentageEl.textContent = `${confidencePercent.toFixed(1)}%`;
                    primaryLabelEl.textContent = 'Om';
                    secondaryPercentageEl.textContent = `${otherPercent.toFixed(1)}%`;
                    secondaryLabelEl.textContent = 'Robot';
                    resultBox.classList.add('result-om');
                }
                
                resultsArea.style.display = 'block';

            } catch (error) {
                console.error('Eroare la clasificare:', error);
                
                // --- AFI»òARE EROARE √éN NOUL FORMAT ---
                primaryPercentageEl.textContent = 'Eroare';
                primaryLabelEl.textContent = error.message;
                
                // Ascundem partea secundarƒÉ la eroare
                primaryResultDiv.style.display = 'block';
                secondaryResultDiv.style.display = 'none';

                resultBox.classList.add('result-eroare');
                resultsArea.style.display = 'block';
            
            } finally {
                // ReactivƒÉm butonul
                classifyBtn.disabled = false;
                classifyBtn.innerHTML = classifyBtnText;

                // --- STOP ANIMA»öIE SCANARE ---
                previewContainer.classList.remove('is-scanning');
                
                // Ascundem bara de progres dupƒÉ o scurtƒÉ √Ænt√¢rziere
                // pentru a ne asigura cƒÉ utilizatorul o vede "plinƒÉ"
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    progressBar.style.animation = 'none'; // Reset
                }, 500); 
            }
        });
    </script>
</body>
</html>